# ระบบบริหารจัดการโครงการ + การเงิน + แม่บ้านเช็คอิน

## 1. วัตถุประสงค์
- จัดการข้อมูลลูกค้า โครงการ และเอกสารทางการเงินแบบศูนย์กลาง
- ลดงานซ้ำซ้อนและลดความผิดพลาดจากการทำงานเอกสาร
- ติดตามสถานะเอกสารและการชำระเงินได้อย่างเป็นระบบ
- บริหารแรงงานแม่บ้านด้วยการเช็คอิน–เช็คเอาต์ผ่านมือถือ พร้อมเก็บหลักฐานและพิกัด
- รองรับรายงานสรุป เช่น ลูกหนี้คงค้าง งบโครงการ ชั่วโมงทำงานแม่บ้าน
- **ทำจ่ายค่าจ้างแม่บ้านแบบรายสัปดาห์ (Weekly Payroll)** ได้

## 2. ผู้ใช้และสิทธิ์ (User Roles)
- **Admin**: จัดการทุกโมดูล, ผู้ใช้, จุดบริการ, กะงาน, มอบหมาย, ตรวจเช็คอิน, ทำจ่ายรายสัปดาห์
- **แม่บ้าน (Housekeeper)**: มือถือเช็คอิน–เช็คเอาต์, ดูกะงาน, อัปโหลดรูป, ดูสลิป/ประวัติการจ่ายของตน

## 3. ขอบเขตฟีเจอร์ (In Scope)

### 3.1 ข้อมูลหลัก (Master Data)
- **ลูกค้า (Customers)**
  - ข้อมูลทั่วไป, เลขภาษี/เลขบัตร, สาขา, สถานะ
  - **ประเภทลูกค้า**: บุคคลธรรมดา / นิติบุคคล / หน่วยงานราชการ / อื่น ๆ
- **โครงการ (Projects)**: รหัส, ชื่อ, ลูกค้า, วันที่เริ่ม–สิ้นสุด, งบประมาณ, สถานะ
- **สินค้า/บริการ (Items Catalog)**: ชื่อ, หน่วย, ราคาเริ่มต้น, VAT flag, WHT default
- **ผู้ใช้ (Users)**: Admin, แม่บ้าน
- **จุดบริการ (Service Points)**: ชื่อ, พิกัด lat/lng, geofence radius, ผูกโครงการ
- **กะงาน (Shifts)**: ชื่อกะ, เวลาเริ่ม–สิ้นสุด, เวลาพัก
- **มอบหมายงาน (Assignments)**: แม่บ้าน ↔ จุดบริการ/กะ/วัน

### 3.2 เอกสารการเงิน (Financial Documents)
- **ใบเสนอราคา (Quotation)**: เลขอัตโนมัติ, ส่วนลด, VAT, WHT, สถานะ, Export PDF
- **ใบวางบิล/ใบแจ้งหนี้ (Invoice)**: เลขอัตโนมัติ, สร้างจาก Quotation, Due, สถานะ, PDF
- **ใบเสร็จรับเงิน (Receipt)**: เลขอัตโนมัติ, รองรับรับชำระบางส่วน
- **บันทึกรับ–จ่าย (Cash Book)**: รับเงินผูก Invoice, จ่ายเงินผูกโครงการ, แนบหลักฐาน

### 3.3 แม่บ้าน & เช็คอิน–เช็คเอาต์
- เช็คอิน: เวลา, GPS (lat/lng+accuracy), รูป, หมายเหตุ
- เช็คเอาต์: เวลา, GPS, รูปหลังงาน, สถานะงาน
- เงื่อนไข: ต้องมี assignment ตรงวัน/กะ, อยู่ใน geofence, ไม่ซ้ำ
- รายงานเข้างาน: สาย/ขาด/ออกก่อน, ชั่วโมงรวมต่อช่วงเวลา

### 3.4 รายงาน (Reports)
- ใบเสนอราคา (ตามสถานะ/ลูกค้า/โครงการ), ลูกหนี้คงค้าง (AR Aging)
- รายรับ–รายจ่ายโครงการ (กำไรขั้นต้น), ภาษีขายเบื้องต้น
- รายงานแม่บ้าน แยกตามกะ/จุดบริการ/โครงการ
- Export PDF/Excel

### 3.5 **ทำจ่ายค่าจ้างรายสัปดาห์ (Weekly Payroll)**
> ฟีเจอร์ใหม่สำหรับสรุปชั่วโมงจาก Attendance และคำนวณค่าจ้างรายสัปดาห์

#### 3.5.1 ขอบเขตการคำนวณ
- **รอบการจ่าย (Pay Period)**: รายสัปดาห์ (กำหนดเริ่ม–สิ้นสุด เช่น จันทร์–อาทิตย์ หรือ อาทิตย์–เสาร์)
- **หน่วยการคำนวณ**: ชั่วโมงทำงานจริง = checkout − checkin − break_minutes (จาก shift)
- **ประเภทอัตราค่าจ้าง** (กำหนดรายคนหรือราย assignment):
  - **รายชั่วโมง (Hourly)**: อัตราต่อชั่วโมง x ชั่วโมงรวม
  - **รายกะ/รายจุด (Per Shift / Per Service Point)**: อัตราคงที่ต่อกะ/ต่อครั้ง (นับจำนวนครั้ง)
  - **รายเดือน (Monthly)** *(ออปชันเตรียมรองรับ)*: คิดสัดส่วนตามวัน/ชั่วโมงของ pay period
- **OT (ล่วงเวลา)** *(ออปชัน)*:
  - กำหนดเงื่อนไข เช่น เกิน X ชั่วโมง/วัน หรือเกิน Y ชั่วโมง/สัปดาห์
  - อัตรา OT เป็นตัวคูณ (เช่น 1.5x) หรืออัตราคงที่/ชม.
- **Allowance/Deduction**:
  - เบี้ยขยัน, ค่าเดินทาง, ค่าอาหาร (ต่อวัน/ต่อกะ/ต่อรอบ)
  - หักขาดงาน/มาสาย/ทำความสะอาดไม่ผ่านตรวจ (กติกากำหนดได้)
- **การปัดเศษเวลา**: ตั้งค่าได้ (ปัดเป็นช่วง 15 นาที / 30 นาที / เต็มนาที)
- **เกณฑ์ตรวจสอบ**:
  - Flag กรณีเวลาเกิน/ขาด, GPS นอกพื้นที่, รูปไม่ชัด → ต้องให้ Admin ตรวจรับก่อนคิดจ่าย

#### 3.5.2 กระบวนการทำจ่าย (Workflow)
1. **ปิดรอบสัปดาห์ (Close Period)**: เลือกช่วงวัน → ระบบรวบรวม Attendance ที่ “อนุมัติแล้ว”
2. **คำนวณ (Preview)**: แสดงชั่วโมง, OT, allowance, deduction, **ยอดสุทธิรายคน**
3. **ตรวจรับ (Approve)**: Admin ตรวจและยืนยันแต่ละคน (แก้ไขค่าปรับ/เบี้ยได้)
4. **ล็อกรอบ (Lock)**: สร้าง **Payroll Run** สถานะ “Approved”
5. **สลิป (Payslip)**: สร้างเอกสาร/หน้าเว็บให้แม่บ้านดู (ดาวน์โหลด PDF ได้)
6. **ทำจ่ายจริง**: บันทึกช่องทางโอน (อ้างอิงเลขที่ธุรกรรมธนาคาร/วันที่โอน)
7. **ประวัติ/ย้อนกลับ**: ดูย้อนหลังตามสัปดาห์/คน/โครงการได้

#### 3.5.3 หน้าจอ/รายงานที่เกี่ยวข้อง
- **Weekly Summary (Admin)**: ตารางรายชื่อแม่บ้านในรอบสัปดาห์ → ชั่วโมง/OT/Allowance/Deduction/สุทธิ
- **Detail Per Person**: รายชื่อ, วัน–กะ–จุด, ชั่วโมงต่อวัน, รูปเช็คอิน–เอาต์, หมายเหตุ/Flag
- **Cost by Project/Service Point (Weekly)**: สรุปต้นทุนแรงงานรายสัปดาห์ต่อโครงการ/จุด
- **Payslip (แม่บ้าน)**: ดูสลิปรายสัปดาห์ของตนเอง
- Export Excel/PDF

#### 3.5.4 โครงสร้างข้อมูลเพิ่มเติม (Database Entities)
- **wage_profiles**: user_id, wage_type(`hourly|per_shift|per_point|monthly`), rate_value, ot_policy_id?, effective_from
- **ot_policies** *(ออปชัน)*: name, daily_threshold_hours, weekly_threshold_hours, multiplier
- **allowance_policies**: name, type(`per_day|per_shift|fixed|per_period`), amount, conditions_json
- **deduction_policies**: name, type(`late|absent|penalty|fixed|per_period`), amount/rule_json
- **pay_periods**: id, start_date, end_date, status(`open|closed|approved|paid`)
- **payroll_runs**: id, pay_period_id, approved_by, approved_at, locked_at, notes
- **payroll_items**: payroll_run_id, user_id, hours, ot_hours, base_pay, ot_pay, allowance_total, deduction_total, net_pay, currency, project_breakdown_json
- **payslips**: payroll_run_id, user_id, slip_no, pdf_path, published_at
- **pay_transactions**: payroll_run_id, user_id, paid_at, method, ref_no, amount, note, attachment

> หมายเหตุ: ใช้ `attendance` ที่ “ผ่านตรวจ” เป็นแหล่งข้อมูลหลักของชั่วโมงทำงาน

---

## 4. นอกขอบเขต (Out of Scope)
- GL/บัญชีแยกประเภท, กระทบยอดธนาคารอัตโนมัติ
- ภาษีแรงงาน/ประกันสังคม/กฎหมายแรงงานแบบครบถ้วน (เตรียมช่องเพิ่มภายหลัง)
- e-Tax สำหรับเงินเดือน/ค่าจ้าง

## 5. กติกาทางธุรกิจ (Business Rules)
- เลขที่เอกสารรันอัตโนมัติและรีเซ็ตตามเดือน/ปี
- Quotation ต้อง Approved ก่อนแปลงเป็น Invoice
- Invoice เป็น Paid เมื่อรับชำระครบตามยอดสุทธิ
- เอกสารที่มีการรับชำระแล้ว “ลบไม่ได้” (ต้องยกเลิก/ออกเอกสารแก้)
- Attendance ต้องถูก **Approve** ก่อนถูกนำไปรวมใน Payroll
- Weekly Payroll: ปิดรอบได้ครั้งละ 1 สัปดาห์, รอบที่ Lock แล้วแก้ไขไม่ได้ (แก้ด้วยรอบ Adjustment แยก)
- การจ่ายเงิน: บันทึกหลักฐานโอน/แนบไฟล์, ออกรหัสสลิป (SLP-YYYYWW-####)
